name: RustDesk-Windows-RDP

on:
  workflow_dispatch: # Jalankan secara manual dari tab Actions

jobs:
  rdp-job:
    runs-on: windows-latest
    timeout-minutes: 360 # Batas maksimal 6 jam

    steps:
      - name: 1. Optimasi Sistem (Desktop Mode)
        run: |
          # Matikan Server Manager agar tidak muncul otomatis
          $registryPath = "HKLM:\SOFTWARE\Microsoft\ServerManager"
          if (!(Test-Path $registryPath)) { New-Item -Path $registryPath -Force }
          Set-ItemProperty -Path $registryPath -Name "DoNotOpenServerManagerAtLogon" -Value 1
          
          # Set Power Plan ke High Performance
          powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          Write-Host "âœ… Sistem diatur ke performa maksimal."

      - name: 2. Download & Instalasi RustDesk
        run: |
          # Download RustDesk versi terbaru
          $url = "https://github.com/rustdesk/rustdesk/releases/download/1.3.7/rustdesk-1.3.7-x86_64.exe"
          $out = "$env:TEMP\rustdesk.exe"
          Invoke-WebRequest -Uri $url -OutFile $out
          
          # Instal secara silent
          Start-Process $out -ArgumentList "--install" -Wait
          Write-Host "âœ… RustDesk berhasil diinstal."

      - name: 3. Konfigurasi Password Permanen
        run: |
          # Mengatur password agar Anda bisa login (Ganti 'BisaLogin123' jika mau)
          & "C:\Program Files\RustDesk\rustdesk.exe" --password BisaLogin123
          Write-Host "âœ… Password ditetapkan: BisaLogin123"

      - name: 4. Mendapatkan ID RustDesk
        run: |
          # Menunggu service RustDesk aktif sepenuhnya
          Start-Sleep -Seconds 20
          $rustdeskId = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id
          echo "RUST_ID=$rustdeskId" >> $env:GITHUB_ENV

      - name: 5. Informasi Akses
        run: |
          Write-Host "`n==========================================" -ForegroundColor Cyan
          Write-Host "ðŸš€ RDP RUSTDESK SIAP DIGUNAKAN" -ForegroundColor Cyan
          Write-Host "=========================================="
          Write-Host "ID RUSTDESK : $env:RUST_ID" -ForegroundColor Yellow
          Write-Host "PASSWORD    : BisaLogin123" -ForegroundColor Yellow
          Write-Host "=========================================="
          Write-Host "Info: Sesi ini akan aktif selama 6 jam."
          Write-Host "Gunakan aplikasi RustDesk di PC Anda untuk menghubungkan."

      - name: 6. Menjaga Sesi (Keep Alive)
        run: |
          $startTime = Get-Date
          while ($true) {
            $elapsed = (Get-Date) - $startTime
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] VPS Aktif - Durasi: $($elapsed.ToString('hh\:mm\:ss'))"
            Start-Sleep -Seconds 300
          }
