name: Windows-10-Pro-RustDesk-SG

on:
  workflow_dispatch: # Jalankan manual

jobs:
  rdp-job:
    runs-on: windows-latest
    timeout-minutes: 360 # Batas maksimal 6 jam

    steps:
      - name: 1. Optimasi Mode Desktop (Windows 10 Pro Style)
        run: |
          # Matikan Server Manager agar tidak mengganggu
          $registryPath = "HKLM:\SOFTWARE\Microsoft\ServerManager"
          if (!(Test-Path $registryPath)) { New-Item -Path $registryPath -Force }
          Set-ItemProperty -Path $registryPath -Name "DoNotOpenServerManagerAtLogon" -Value 1
          
          # Set Power Plan ke High Performance
          powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
          Write-Host "âœ… System Optimized to Desktop Mode"

      - name: 2. Download & Instalasi RustDesk
        run: |
          $url = "https://github.com/rustdesk/rustdesk/releases/download/1.2.3-2/rustdesk-1.2.3-2-x86_64.exe"
          $out = "$env:TEMP\rustdesk.exe"
          Invoke-WebRequest -Uri $url -OutFile $out
          # Jalankan instalasi secara silent
          Start-Process $out -ArgumentList "--install" -Wait
          Write-Host "âœ… RustDesk Installed Successfully"

      - name: 3. Konfigurasi Password RustDesk
        run: |
          # Mengatur password permanen agar Anda bisa login
          # Ganti 'ProUser123' jika ingin password berbeda
          & "C:\Program Files\RustDesk\rustdesk.exe" --password ProUser123
          Write-Host "âœ… Permanent Password Set: ProUser123"

      - name: 4. Dapatkan ID RustDesk
        run: |
          # Menunggu service RustDesk siap
          Start-Sleep -Seconds 15
          $rustdeskId = & "C:\Program Files\RustDesk\rustdesk.exe" --get-id
          echo "RUST_ID=$rustdeskId" >> $env:GITHUB_ENV

      - name: 5. Informasi Koneksi
        run: |
          Write-Host "`n==========================================" -ForegroundColor Cyan
          Write-Host "ðŸš€ RUSTDESK WINDOWS 10 PRO READY" -ForegroundColor Cyan
          Write-Host "=========================================="
          Write-Host "ID RUSTDESK : $env:RUST_ID" -ForegroundColor Yellow
          Write-Host "PASSWORD    : ProUser123" -ForegroundColor Yellow
          Write-Host "REGION      : Auto (Singapore/Asia Optimized)"
          Write-Host "=========================================="
          Write-Host "Gunakan aplikasi RustDesk di PC Anda dan masukkan ID di atas."
          Write-Host "`n"

      - name: 6. Menjaga Sesi (Keep Alive)
        run: |
          $timer = [diagnostics.stopwatch]::StartNew()
          while ($timer.Elapsed.TotalMinutes -lt 360) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RustDesk Running - Performance Stable..."
            Start-Sleep -Seconds 300
          }
